<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Рисовалка для Telegram</title>
    <!-- Подключаем скрипт Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: var(--tg-theme-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000);
            height: 100vh;
            overflow: hidden;
            font-family: sans-serif;
        }

        h1 { margin: 10px 0; font-size: 18px; }

        canvas {
            background: #fff;
            border: 2px solid var(--tg-theme-button-color, #3390ec);
            border-radius: 10px;
            cursor: crosshair;
            touch-action: none;
        }

        .controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            width: 90%;
            justify-content: center;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.2s;
        }

        button:active { opacity: 0.7; }

        #clearBtn {
            background-color: var(--tg-theme-secondary-bg-color, #e0e0e0);
            color: var(--tg-theme-text-color, #000);
        }

        #sendBtn {
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #fff);
            flex-grow: 1;
        }

        /* Модальное окно для инструкции / ручного ввода ID */
        #overlay {
            position: absolute;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.6);
            z-index: 999;
        }
        #overlay .box {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            max-width: 420px;
            width: 90%;
            color: #000;
        }
        #overlay input {
            width: 100%;
            padding: 10px;
            margin-top: 8px;
            margin-bottom: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }
        #overlay button { width: 100%; }
        #instr { font-size: 14px; color: #333; }
    </style>
</head>
<body>

    <h1>Нарисуй что-нибудь!</h1>
    <canvas id="drawingCanvas"></canvas>

    <div class="controls">
        <button id="clearBtn">Очистить</button>
        <button id="sendBtn">Отправить</button>
    </div>

    <div id="overlay">
        <div class="box">
            <div id="instr">
                Не удалось определить ID пользователя. Это значит, что вы открыли страницу не как Telegram Web App.
                Откройте эту страницу через Telegram Web App (через кнопку Web App у вашего бота), либо
                вставьте сюда свой Telegram user ID для тестовой отправки.
                <br><br>
                Как получить ID: откройте @userinfobot или @get_id_bot в Telegram — он вернёт ваш числовой ID.
            </div>

            <input id="manualId" placeholder="Вставьте Telegram user ID для теста (напр. 123456789)" />
            <button id="useIdBtn">Использовать этот ID для теста</button>
            <button id="openInstrBtn" style="margin-top:8px;background:#eee;color:#000;">Закрыть</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram?.WebApp || {};
        try { if (tg.expand) tg.expand(); } catch(e){ /* ignore if not in telegram */ }

        // Канвас
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        let painting = false;

        function resizeCanvas() {
            canvas.width = window.innerWidth * 0.9;
            canvas.height = window.innerHeight * 0.7;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        function startPosition(e) {
            painting = true;
            draw(e);
        }
        function finishedPosition() {
            painting = false;
            ctx.beginPath();
        }
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }
        function draw(e) {
            if (!painting) return;
            e.preventDefault();
            ctx.lineWidth = 5;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000';
            const pos = getPos(e);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }

        canvas.addEventListener('mousedown', startPosition);
        canvas.addEventListener('mouseup', finishedPosition);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('touchstart', startPosition);
        canvas.addEventListener('touchend', finishedPosition);
        canvas.addEventListener('touchmove', draw);

        document.getElementById('clearBtn').addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        });

        // --- Обработчик отправки ---
        async function getUserIdOrPrompt() {
            // Пытаемся взять id из Telegram WebApp initDataUnsafe
            const tgUserId = tg?.initDataUnsafe?.user?.id || tg?.initData?.user?.id;
            if (tgUserId) return tgUserId;

            // Если нет — смотрим в сохранённом тестовом id
            const saved = localStorage.getItem('TEST_TG_USER_ID');
            if (saved) return saved;

            // иначе показываем оверлей с объяснением и полем для ввода
            document.getElementById('overlay').style.display = 'flex';
            return null;
        }

        document.getElementById('useIdBtn').addEventListener('click', () => {
            const v = document.getElementById('manualId').value.trim();
            if (!v) { alert('Введите id'); return; }
            localStorage.setItem('TEST_TG_USER_ID', v);
            document.getElementById('overlay').style.display = 'none';
            alert('Тестовый ID сохранён. Попробуйте снова нажать "Отправить".');
        });
        document.getElementById('openInstrBtn').addEventListener('click', () => {
            document.getElementById('overlay').style.display = 'none';
        });

        document.getElementById('sendBtn').addEventListener('click', async () => {
            let userId = await getUserIdOrPrompt();
            if (!userId) return; // overlay открыт, ждём ввода

            // Превращаем канвас в Blob
            canvas.toBlob(async (blob) => {
                if (!blob) {
                    alert('Пустой рисунок');
                    return;
                }

                // ВАЖНО: НЕ храните BOT_TOKEN в клиентском коде.
                // Настройте бэкенд-эндпоинт /api/sendPhoto, который принимает multipart/form-data
                // с полями chat_id и photo, и уже с сервера шлёт запрос в Telegram Bot API,
                // где токен хранится в переменных окружения.
                const formData = new FormData();
                formData.append('chat_id', userId);
                formData.append('photo', blob, 'drawing.png');

                try {
                    const sendBtn = document.getElementById('sendBtn');
                    const prevText = sendBtn.innerText;
                    sendBtn.innerText = 'Отправка...';
                    sendBtn.disabled = true;

                    // Запрос на ваш бэкенд (его нужно реализовать!)
                    const resp = await fetch('/api/sendPhoto', {
                        method: 'POST',
                        body: formData
                    });

                    if (!resp.ok) {
                        const txt = await resp.text();
                        alert('Ошибка сервера: ' + (txt || resp.status));
                        return;
                    }
                    const data = await resp.json();
                    if (data.ok) {
                        // если WebApp — можно закрыть, иначе показать успех
                        try { if (tg && tg.close) tg.close(); } catch(e){}
                        alert('Отправлено успешно');
                    } else {
                        alert('Ошибка отправки: ' + (data.description || JSON.stringify(data)));
                    }
                } catch (err) {
                    alert('Ошибка сети: ' + err.message);
                } finally {
                    document.getElementById('sendBtn').innerText = 'Отправить';
                    document.getElementById('sendBtn').disabled = false;
                }
            });
        });
    </script>
</body>
</html>
